version: "3"

tasks:
  app:up:
    desc: Build and start containers in detached mode
    cmd: docker compose up -d --build

  app:down:
    desc: Stop and remove containers
    cmd: docker compose down

  app:stop:
    desc: Stop containers without removing them
    cmd: docker compose stop

  app:run:
    desc: Start the FastAPI app with live reload
    cmd: docker compose exec app uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  app:restart:
    desc: Trigger a reload of the FastAPI app
    cmd: docker compose exec app touch main.py

  app:lock:
    desc: Regenerate uv.lock from pyproject.toml
    cmd: docker compose exec app uv lock

  app:sync:
    desc: Install all dependencies from uv.lock
    cmd: docker compose exec app uv sync --frozen

  app:add:
    desc: "Add a package (usage: task app:add -- <package>)"
    cmd: docker compose exec app uv add {{.CLI_ARGS}}

  app:remove:
    desc: "Remove a package (usage: task app:remove -- <package>)"
    cmd: docker compose exec app uv remove {{.CLI_ARGS}}

  app:test:
    desc: Run tests
    cmd: docker compose exec app pytest tests/ -v

  app:test-file:
    desc: "Run a specific test file (usage: task app:test-file -- tests/routers/test_auth.py)"
    cmd: docker compose exec app pytest {{.CLI_ARGS}} -v

  app:create-admin:
    desc: "Create an admin user (usage: task app:create-admin)"
    cmd: docker compose exec app python -m app.cli.create_admin

  app:migrate:
    desc: Run database migrations
    cmd: docker compose exec app alembic upgrade head

  app:migration:
    desc: "Create a new migration (usage: task app:migration -- 'description')"
    cmd: docker compose exec app alembic revision --autogenerate -m "{{.CLI_ARGS}}"
