# Boone Gifts Backend

## Overview
FastAPI backend for the Boone Gifts project. Python 3.14, runs entirely in Docker (no host virtual environment).

## Architecture
- **Framework**: FastAPI with Uvicorn
- **ORM**: SQLAlchemy 2.0 with mapped columns
- **Validation**: Pydantic v2 (v2.12+) — uses `model_config`, `model_dump()`, `from_attributes` (not Pydantic v1 patterns like `class Config`, `.dict()`, `orm_mode`)
- **Config**: pydantic-settings with `env_prefix` and `env_file`
- **Auth**: JWT (PyJWT) with bcrypt password hashing
- **Migrations**: Alembic (autogenerate from SQLAlchemy models)
- **Package management**: uv in project mode (`pyproject.toml` + `uv.lock`)
- **Testing**: pytest + FastAPI TestClient with transactional test fixtures

## Development Workflow
```
task up              # Build image and start container (detached, runs uvicorn)
task logs            # Follow the app container logs
task restart         # Restart the app container
task stop            # Stop container without removing
task down            # Stop and remove container
tasktest        # Run test suite (pytest)
tasktest-file -- <path>  # Run a specific test file or test function
taskcreate-admin  # Create an admin user (interactive prompts)
taskmigrate     # Run database migrations (alembic upgrade head)
taskmigration -- 'description'  # Create a new migration
```

## Dependency Management
```
task add -- <package>      # Add a package (updates pyproject.toml + uv.lock + installs)
task remove -- <package>   # Remove a package (updates pyproject.toml + uv.lock + uninstalls)
task lock                  # Regenerate uv.lock from pyproject.toml
```

## Project Structure
```
main.py              # Thin entrypoint: imports app from app.main
pyproject.toml       # Project metadata and direct dependencies
uv.lock              # Pinned dependencies (generated by uv, do not edit manually)
.python-version      # Python version for uv (3.14)
Dockerfile           # Python 3.14-slim + uv, installs deps, idles
docker-compose.yml   # App service on proxy network with Traefik labels
Taskfile.yaml        # All dev commands under app: namespace
alembic.ini          # Alembic config (DB URL set in env.py, not here)
app/
  __init__.py
  main.py            # FastAPI app factory with CORS, routers, /health endpoint
  config.py          # Settings via pydantic-settings (APP_ env prefix, .env file)
  database.py        # SQLAlchemy engine, sessionmaker, Base
  dependencies.py    # get_db, JWT token creation, get_current_user, require_admin, list access deps, require_connection, get_collection_for_owner
  models/
    __init__.py      # Exports User, Invite, GiftList, Gift, ListShare, Connection, Collection, CollectionItem
    user.py          # User model (email, name, password_hash, role, is_active)
    invite.py        # Invite model (token, email, role, expires_at, used_at)
    gift_list.py     # GiftList model (name, description, owner_id)
    gift.py          # Gift model (name, description, url, price, claim tracking)
    list_share.py    # ListShare model (list_id, user_id, unique constraint)
    connection.py    # Connection model (requester_id, addressee_id, status, unique constraint)
    collection.py    # Collection model (name, description, owner_id)
    collection_item.py # CollectionItem model (collection_id, list_id, unique constraint)
  schemas/
    __init__.py
    user.py          # UserRead, UserUpdate
    auth.py          # LoginRequest, RegisterRequest, TokenResponse, RefreshRequest, AccessTokenResponse
    invite.py        # InviteCreate, InviteRead
    gift_list.py     # GiftListCreate, GiftListUpdate, GiftListRead, GiftListDetail*, GiftOwnerRead, GiftRead
    gift.py          # GiftCreate, GiftUpdate
    list_share.py    # ListShareCreate, ListShareRead
    connection.py    # ConnectionCreate, ConnectionUserRead, ConnectionRead
    collection.py    # CollectionCreate, CollectionUpdate, CollectionRead, CollectionDetail, CollectionItemCreate
  routers/
    __init__.py
    auth.py          # POST /auth/login, /auth/register, /auth/refresh
    users.py         # GET/PUT/DELETE /users (admin-only)
    invites.py       # POST/GET/DELETE /invites (admin-only)
    lists.py         # POST/GET/PUT/DELETE /lists
    gifts.py         # POST/PUT/DELETE /lists/{id}/gifts, POST/DELETE claim
    list_shares.py   # POST/GET/DELETE /lists/{id}/shares
    connections.py   # POST/GET/DELETE /connections, GET /connections/requests, POST accept
    collections.py   # POST/GET/PUT/DELETE /collections, POST/DELETE /collections/{id}/items
  cli/
    __init__.py
    create_admin.py  # Interactive CLI to create first admin user
alembic/
  env.py             # Configured to use app models and settings.database_url
  versions/          # Migration scripts
tests/
  __init__.py
  conftest.py        # Test fixtures: db, client, admin_user, member_user, tokens, headers, sample_list, shared_list, connection, collection, collection_item
  models/            # Model unit tests (user, invite, gift_list, gift, list_share, connection, collection)
  routers/           # Endpoint tests (auth, users, invites, lists, gifts, list_shares, connections, collections)
```

## App Entrypoint
Top-level `main.py` imports `app` from `app.main`. The app factory (`create_app()`) sets up CORS middleware, includes all routers, and adds a `/health` endpoint that queries the database with `SELECT 1` (returns 503 on failure). Uvicorn serves it as `main:app` on port 8000.

## Authentication & Authorization
- **Access token**: JWT HS256, 30 min TTL, contains user id/email/role
- **Refresh token**: JWT HS256, 7 day TTL, contains user id + type="refresh"
- **JWT `sub` claim**: Must be a string (PyJWT RFC 7519 compliance) — `str(user.id)` when encoding, `int(payload["sub"])` when decoding
- **Password hashing**: bcrypt
- **Route protection**: `get_current_user` (401 if invalid), `require_admin` (403 if not admin)
- **Defense in depth**: `get_current_user` rejects refresh tokens and checks `is_active` — inactive users cannot authenticate even with a valid token
- **Registration**: Invite-only — the registrant's email comes from the invite record, not the request body
- **First admin**: Created via `taskcreate-admin`
- **Gift list access**: `get_list_for_owner` (403 if not owner), `get_list_for_viewer` (403 if not owner or shared)
- **Gift responses**: `GiftOwnerRead` (no claim fields) for owners, `GiftRead` (with claim fields) for shared users

## Environment Variables

| Variable | Description |
|---|---|
| `APP_DATABASE_URL` | MySQL connection string |
| `APP_TEST_DATABASE_URL` | MySQL connection string for tests |
| `APP_JWT_SECRET` | Secret key for JWT signing |
| `APP_CORS_ORIGINS` | Allowed CORS origins (JSON array) |

## Testing
- 130 tests: 22 model + 11 auth + 10 users + 7 invites + 14 lists + 16 gifts + 12 list shares + 20 connections + 18 collections
- Tests run against `boone_gifts_test` database
- Each test wrapped in a transaction that rolls back (no persistent test data)
- `cryptography` package required by PyMySQL for MySQL 8's `caching_sha2_password` authentication — do not remove

## Key Design Decisions
- **Router endpoints use `db.flush()`, not `db.commit()`** — transaction management is delegated to the caller. In tests, the fixture rolls back; in production, FastAPI's dependency teardown commits. New endpoints should follow this pattern.
- Packages install to `/opt/venv` (`UV_PROJECT_ENVIRONMENT=/opt/venv`) to avoid being shadowed by the bind mount; `/opt/venv/bin` is on `PATH`
- Uvicorn runs with `--reload` in the container so manual restarts are rarely needed
- `task restart` restarts the container for edge cases where the file watcher doesn't pick up a change
- After adding deps with `task add`, run `task up` to rebuild the image so deps persist across container recreations
